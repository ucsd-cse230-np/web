<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
    
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
 <!--
      loads the http over https ssl -
      welcome to my website!

	this theme is based off the Ice & Fire theme created by Lucas Gatsas
      https://www.twitter.com/LucasGatsas
      www.lucasgatsas.ch - switzerland.
  -->


<!-- Microsoft Internet Explorer documentMode compatMode setting IE Modus -->
<script type="text/javascript">
var IE = null;
if (window.navigator.appName == "Microsoft Internet Explorer") {
  if (document.documentMode) {

    IE = document.documentMode;
    } else {

        IE = 5;
          if (document.compatMode) {
      if (document.compatMode == "CSS1Compat")
      IE = 11;
      }
    }
  }
</script>

    <meta charset="utf-8">
    <!-- X-UA -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="X-UA-Compatible" content="IE=11" />
    <link rel="author" title="Ranjit Jhala" href="http://ranjitjhala.github.io" />

    <meta name="google" content="notranslate" />
    <!-- Viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- index ROBOTS follow -->
    <meta name="robots" content="index, follow" />
    <!-- Site Desciption -->
    <meta name="description" content="UCSD CSE 230">
    <!-- Site Desciption -->
    <meta name="keywords" content="haskell, refinement types, liquid types, formal methods, type systems">
    <!-- Favicon -->
    <link rel="shortcut icon" href="https://ucsd-cse230.github.io/fa21/static/img/ico.png" type="image/x-icon" />
    <!-- Blog Title -->
    <title>cse230</title>

    <!--     <title>{% if page.title %}{{ page.title }} - {{ site.title }}{% else %}{{ site.title }}{% endif %}</title>
-->
    <!-- Property Metas -->
    <meta property="og:image" content="https://ucsd-cse230.github.io/fa21/static/img/ix.png" />
    <meta property="og:title" content="UCSD CSE 230" />
    <meta property="og:site_name" content="UCSD CSE 230" />
    <!-- Canonical -->
    <link rel="canonical" href="{{ page.url | replace:'index.html','' | prepend: site.baseUrl | prepend: site.url }}">
    <!-- StyleSheet -->
    <link rel="stylesheet" href="https://ucsd-cse230.github.io/sp20/static/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://ucsd-cse230.github.io/sp20/static/css/ronacher.css" type="text/css">
    <link rel="stylesheet" href="https://ucsd-cse230.github.io/sp20/static/css/syntax.css">
    <link rel="stylesheet" href="https://ucsd-cse230.github.io/sp20/static/css/liquid-light.css">

    <!-- Fonts
    <link href='https://fonts.googleapis.com/css?family=Merriweather:400,300,300italic,400italic,700,700italic,900,900italic' rel='stylesheet' type='text/css'>
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href='https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Playfair+Display:400,700,900,400italic,700italic,900italic' rel='stylesheet' type='text/css'>
    -->

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
    <style>
	#preloader {position:fixed;top:0;left:0;right:0;bottom:0;background-color:#fff; /* change if the mask should have another color then white */z-index:99; /* makes sure it stays on top */}
	#status {width:200px;height:200px;position:absolute;left:50%; /* centers the loading animation horizontally one the screen */top:50%; /* centers the loading animation vertically one the screen */background-image:url("/static/img/preloader.gif"); /* path to your loading animation */background-repeat:no-repeat;background-position:center;margin:-100px 0 0 -100px; /* is width and height divided by two */}
	ul, ol {margin-top: 0;margin-bottom: 10px;}
	.navbar-inverse {background-color: #FFF;border-color: #FFFFFF;}
</style>
<style>
  /* HEADER IMAGE */
  header.intro-header {background: #6f5499;background: no-repeat center center;background-attachment: scroll;-webkit-background-size: cover;-moz-background-size: cover;background-size: cover;-o-background-size: cover;}

	/* Preloader */#preloader {position:fixed;top:0;left:0;right:0;bottom:0;background-color:#fff; /* change if the mask should have another color then white */z-index:99; /* makes sure it stays on top */}
	#status {width:200px;height:200px;position:absolute;left:50%; /* centers the loading animation horizontally one the screen */top:50%; /* centers the loading animation vertically one the screen */background-image:; /* path to your loading animation */background-repeat:no-repeat;background-position:center;margin:-100px 0 0 -100px; /* is width and height divided by two */}
	li {list-style: none;}
            body.modal-open
            {overflow: hidden;padding-right: 0px;
        }
	article li {list-style: inherit;}
	article .figure {text-align: center}
    </style>
    <!-- end Loading front stylesheet here -->
    </head>

    <body>
	    
	<!-- 	
        <div id="preloader">
	    <div id="status">
	    </div>
	</div>  
	-->
	<!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://ucsd-cse230.github.io/fa21" id="blog-title-left-top">cse230</a>
        </div>
        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <li><a href="https://ucsd-cse230.github.io/fa21/calendar.html">Calendar</a></li>
                <li><a href="https://ucsd-cse230.github.io/fa21/contact.html">Contact</a></li>
                <li><a href="https://ucsd-cse230.github.io/fa21/grades.html">Grades</a></li>
                <li><a href="https://ucsd-cse230.github.io/fa21/lectures.html">Lectures</a></li>
                <li><a href="https://ucsd-cse230.github.io/fa21/assignments.html">Assignments</a></li>
                <li><a href="https://ucsd-cse230.github.io/fa21/links.html">Links</a></li>
                <li><a href="https://www.piazza.com/class/ktu6rpy6cmh79" id="roundbutton" target="_blank"><i class="fa fa-twitter"></i>Piazza</a></li>
                <li><a href="https://canvas.ucsd.edu/courses/29526" id="roundbutton" target="_blank"><i class="fa fa-twitter"></i>Canvas</a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<!-- Portfolio Modals -->
    <div class="portfolio-modal modal fade" id="portfolioModal1" tabindex="-1" role="dialog" aria-hidden="true" style="padding-right:0px; overflow: hidden;">
        <div class="modal-content">
            <div class="close-modal" data-dismiss="modal">
                <div class="lr">
                    <div class="rl">
                    </div>
                </div>
            </div>
            <div class="container">
                <div class="row">
                    <div class="col-lg-8 col-lg-offset-2">
                        <div class="modal-body">
                            <h1 class="font-style-inline-small-h1">Ranjit Jhala</h1>
                            <hr class="star-primary">
                            <img src="https://ucsd-cse230.github.io/fa21/static/img/ico.png" class="img-responsive img-centered" alt title>
                            <p class="font-style-inline-small">
                                <a href="https://www.twitter.com/ranjitjhala" target="_blank">follow me</a>. <br>
                                <a href="https://www.github.com/ranjitjhala" target="_blank">    <i class="fa fa-github" id="spaceg-social-modal"></i> </a>
                                <a href="https://www.twitter.com/ranjitjhala" target="_blank"><i class="fa fa-twitter" id="spaceg-social-modal"></i> </a>
                                <a href="https://plus.google.com/u/0/104385825850161331469" target="_blank"> <i class="fa fa-google-plus" id="spaceg-social-modal"></i></a>
                            </p>
                            <button type="button" class="btn btn-default" data-dismiss="modal"><i class="fa fa-times"></i> Close</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
<!-- Menu Modals Add New Sa.21.Feb.2015 03:22:25 -->
    <div class="portfolio-modal modal fade" id="portfolioModal2" tabindex="-1" role="dialog" aria-hidden="true" style="padding-right:0px; overflow: hidden;">
        <div class="modal-content">
            <div class="close-modal" data-dismiss="modal">
                <div class="lr">
                    <div class="rl">
                    </div>
                </div>
            </div>
            <div class="container">
                <div class="row">
                    <div class="col-lg-8 col-lg-offset-2">
                        <div class="modal-body">
                            <h1 class="font-style-inline-small-h1">Ranjit Jhala</h1>
                            <hr class="star-primary">
                            <p class="font-style-inline-small">
                              <a href="https://www.twitter.com/ranjitjhala" target="_blank">follow</a>. <br>
                              <a href="https://www.github.com/ranjitjhala" target="_blank">    <i class="fa fa-github" id="spaceg-social-modal"></i> </a>
                              <li><a href="https://ucsd-cse230.github.io/fa21/calendar.html">Calendar</a></li>
                              <li><a href="https://ucsd-cse230.github.io/fa21/contact.html">Contact</a></li>
                              <li><a href="https://ucsd-cse230.github.io/fa21/grades.html">Grades</a></li>
                              <li><a href="https://ucsd-cse230.github.io/fa21/lectures.html">Lectures</a></li>
                              <li><a href="https://ucsd-cse230.github.io/fa21/assignments.html">Assignments</a></li>
                              <li><a href="https://ucsd-cse230.github.io/fa21/links.html">Links</a></li>
                              <li><a href="https://www.piazza.com/class/ktu6rpy6cmh79" id="roundbutton" target="_blank"><i class="fa fa-twitter"></i>Piazza</a></li>
                              <li><a href="https://canvas.ucsd.edu/courses/29526" id="roundbutton" target="_blank"><i class="fa fa-twitter"></i>Canvas</a></li>
                            </p>
                            <button type="button" class="btn btn-default" data-dismiss="modal"><i class="fa fa-times"></i>Close</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


        <div id="content">
            <!-- Post Header -->
    <header class="intro-header" style="background-image: url('https://ucsd-cse230.github.io/fa21/static/img/books.jpg')" alt title>

    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <h1>Concurrency</h1>
                    
                    <span class="meta">
		    
		    </span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->


<article>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
			<h2 id="mutable-state-via-ioref">1. Mutable State Via IORef</h2>

<h2 id="forking-a-thread">2. Forking A Thread</h2>

<h2 id="randomly-fuzzing-the-thread-scheduler">3. Randomly Fuzzing the Thread Scheduler</h2>

<h2 id="data-races-due-to-sharing">3. Data Races due to sharing</h2>
<p>Bank account revisited; depositing with different threads, and fuzzed scheduler</p>
<h2 id="mvars-vanilla">4. MVars: Vanilla</h2>
<p>Shared Message-Box-Variables <code class="sourceCode haskell"><span class="dt">MVar</span></code></p>
<ul>
<li>Message Box has EITHER an <code class="sourceCode haskell">a</code> or is EMPTY</li>
</ul>
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true"></a><span class="kw">data</span> <span class="dt">MVar</span> a</span></code></pre></div>
<ul>
<li>Create an EMPTY Reference</li>
</ul>
<div class="sourceCode" id="cb2"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true"></a><span class="ot">    newEmptyMVar ::</span> <span class="dt">IO</span> (<span class="dt">MVar</span> a)</span></code></pre></div>
<ul>
<li>Create a FULL reference</li>
</ul>
<div class="sourceCode" id="cb3"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true"></a><span class="ot">    newMVar	     ::</span> a <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">MVar</span> a)</span></code></pre></div>
<ul>
<li>Blocks until box is full, takes out contents</li>
</ul>
<div class="sourceCode" id="cb4"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true"></a><span class="ot">    takeMVar	 ::</span> <span class="dt">MVar</span> a <span class="ot">-&gt;</span> <span class="dt">IO</span> a</span></code></pre></div>
<ul>
<li>Overwrites contents with new contents</li>
</ul>
<div class="sourceCode" id="cb5"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true"></a><span class="ot">    putMVar	     ::</span> <span class="dt">MVar</span> a <span class="ot">-&gt;</span> a <span class="ot">-&gt;</span> <span class="dt">IO</span> ()</span></code></pre></div>
<p><strong>Uses of <code class="sourceCode haskell"><span class="dt">MVar</span></code></strong></p>
<ol type="1">
<li><p>An MVar is a useful container for shared mutable state, e.g. common design pattern where threads need read and write access to some state, is to represent the state value as an ordinary immutable Haskell data structure stored in an MVar.</p></li>
<li><p>An MVar is a one-place channel, which can be used for asynchronous communication between two threads.</p></li>
<li><p>An MVar () is a lock; takeMVar acquires the lock and putMVar releases it again. An MVar used in this way can protect shared mutable state or critical sections.</p></li>
<li><h2 id="mvars-bankaccountdeposit">MVars: BankAccount/Deposit</h2></li>
</ol>
<p>Bank account revisited; using MVars, depositing with different threads, and fuzzed scheduler</p>
<h2 id="asynchrony-via-mvars">6. Asynchrony Via MVars</h2>
<p>Can implement “asynchronous” function calls (aka “futures”, “promises”) using <code class="sourceCode haskell"><span class="dt">MVar</span></code>s. Other languages “features” are Haskell’s, “functions”…</p>
<p>A type representing an Asynchronous Computation</p>
<p>Function to execute an IO action <code class="sourceCode haskell">async</code>-hronously</p>
<p>Reading ALL the URLs <strong>in sequence</strong> (i.e. a single thread) with <code class="sourceCode haskell"><span class="fu">mapM</span></code></p>
<p>Recall that:</p>
<p>Reading ALL the URLs <strong>asynchronously</strong> with <code class="sourceCode haskell">async</code></p>
<p>Spawn-then-wait in parallel is a general pattern; lets <strong>generalize</strong> into <code class="sourceCode haskell">asyncMapM</code></p>
<p><strong>Note:</strong> <em>Exact</em> type as <code class="sourceCode haskell"><span class="fu">mapM</span></code> – so you can literally just drop-in replace to get parallelism.</p>
<p>Reading ALL URLs with <code class="sourceCode haskell">asyncMapM</code></p>
<p>synchronize (l) { // act }</p>
<p>synchronize :: Lock -&gt; IO a -&gt; IO a</p>
<p>synchronize l act</p>
<h2 id="java-style-synchronization-via-mvars">7. Java-style Synchronization via MVars</h2>
<p>Next, lets see how <code class="sourceCode haskell"><span class="dt">MVars</span></code> give us Java style <code class="sourceCode haskell">synchronize</code>, as a simple function, no need to extend the language.</p>
<p><strong>Key idea:</strong> Execute an action <strong>while holding lock</strong></p>
<p><strong>MVars as Locks</strong></p>
<p><strong>Acquiring Locks</strong></p>
<ul>
<li>Just <strong>take</strong> the <code class="sourceCode haskell"><span class="dt">MVar</span></code>s contents!</li>
<li>Subsequent calls to <code class="sourceCode haskell">acquire</code> will block…</li>
</ul>
<p><strong>Releasing Locks</strong></p>
<ul>
<li>Just <strong>put back</strong> the <code class="sourceCode haskell"><span class="dt">MVar</span></code>s contents!</li>
<li>Subsequent calls to <code class="sourceCode haskell">acquire</code> will now get unblocked…</li>
</ul>
<p><strong>Synchronized “Blocks”</strong></p>
<p>Now, a Java style <code class="sourceCode haskell">synchronize</code> block</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true"></a><span class="kw">synchronized</span> (l) {</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true"></a>  statement</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true"></a>}</span></code></pre></div>
<p>is just a simple Haskell function:</p>
<p><strong>Exercise</strong> Can you think of a bug in the above? How would you fix it?</p>
<h2 id="synchronized-bank-accounts">8. “Synchronized” Bank Accounts</h2>
<p>A <code class="sourceCode haskell">synchronize</code>d deposit that prevents races…</p>
<p><strong>Exercise:</strong> What happens if you comment out the <code class="sourceCode haskell">synchronize l</code> ?</p>
<p>Btw, why are we using <code class="sourceCode haskell">asyncMapM</code> not something like <code class="sourceCode haskell">forkMapM</code>?</p>
<p>Try to use this instead of <code class="sourceCode haskell">asyncMapM</code> above and see if you can figure it out.</p>
<p><strong>Hint:</strong> after forking, parent does not wait for children to finish…</p>
<h2 id="global-locks-means-zero-concurrency">9. GLOBAL Locks means Zero Concurrency</h2>
<p>Pretty silly if the <strong>entire</strong> bank froze up to handle a <strong>single</strong> customer!</p>
<p><code class="sourceCode haskell"><span class="dt">AccountMV</span></code> has a local lock per account, lets simulate with explicit lock.</p>
<p>Create a new “locked” account</p>
<p>Now, lets do concurrent deposits, but make sure we use the <em>same</em> lock…</p>
<h2 id="transactions-compose">Transactions Compose</h2>
<p>Trivial to compose actions without worrying about <em>deadlock</em> or <em>race</em></p>
<p>No need for <strong>any</strong> synchronization, just say <code class="sourceCode haskell">atomic</code></p>
                <hr>
            </div>
        </div>
    </div>
</article>

        </div>
        <div id="footer">
        </div>
      <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    <li>
                        <a href="https://ucsd-cse230.github.io/fa21/feed.xml" data-datatype="json" data-type="GET" data-target="#frame" class="reload" id="clickme">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    <li>
                        <a href="https://twitter.com/ranjitjhala" data-datatype="json" data-type="GET" data-target="#frame" class="reload" id="clickme" target="_blank">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a href="https://plus.google.com/u/0/104385825850161331469" data-datatype="json" data-type="GET" data-target="#frame" class="reload" id="clickme" target="_blank">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-google-plus fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a href="https://github.com/ranjitjhala" target="_blank">
                            <span class="fa-stack fa-lg">

                              <i class="fa fa-arrow-circle-o-down"></i>
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
		    
                </ul>
                <p class="copyright text-muted">
                
                  Generated by <a href="http://jaspervdj.be/hakyll">Hakyll</a>,
                  template by <a href="http://lucumr.pocoo.org">Armin Ronacher</a>,
                  suggest improvements <a href="https://github.com/ucsd-progsys/liquidhaskell-blog/">here</a>.
                </p>
            </div>
        </div>
    </div>
</footer>


<!-- jQuery -->
<script src="https://ucsd-cse230.github.io/fa21/static/js/jquery.min.js"></script>
<script src="https://ucsd-cse230.github.io/fa21/static/js/spaceg.stylesheets.min.js"></script>
<script src="https://ucsd-cse230.github.io/fa21/static/js/bootstrap.min.js"></script>
<!--
<script src="https://cdn.rawgit.com/google/code-prettify/master/loader/run_prettify.js"></script>
<script src="https://ucsd-cse230.github.io/fa21/static/js/anim.js"></script>
<script src="https://ucsd-cse230.github.io/fa21/static/js/scripts.js"></script>
-->


    </body>
</html>
